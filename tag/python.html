<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hannah Clare Wray Hazi | articles tagged "Python"</title>
    <link rel="shortcut icon" type="image/png" href="../favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">
    <link rel="stylesheet" href="../theme/css/screen.css" type="text/css" />
    <link rel="stylesheet" href="../theme/css/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../theme/css/print.css" type="text/css" media="print" />
    <meta name="generator" content="Pelican" />
    <meta name="description" content="" />
    <meta name="author" content="Hannah Hazi" />
</head>
<body>
    <header>
        <nav>
            <ul>
                <li class="ephemeral selected"><a href="../tag/python.html">Python</a></li>
                <li><a href="../">Home</a></li>
                <li><a href="../pages/about.html">About Me</a></li>
                <li><a href="https://github.com/raspberrycheesecake">GitHub</a></li>
                <li><a href="mailto:hannah.hazi@cantab.net">Contact Me</a></li>
                <li><a href="https://uk.linkedin.com/in/hannah-hazi-9b985a84">LinkedIn</a></li>
                <li><a href="../archives">Archives</a></li>
            </ul>
        </nav>
        <div class="header_box">
            <h1><a href="../">Hannah Clare Wray Hazi</a></h1>
            <h2>I love making beautiful things.</h2>
        </div>
    </header>
    <div id="wrapper">
        <div id="content">            <h4 class="date">Feb 13, 2017</h4>

            <article class="post">
                <h2 class="title">
                    <a href="../monkey-patching.html" rel="bookmark" title="Permanent Link to &quot;Monkey Patching Reprise&quot;">Monkey Patching Reprise</a>
                </h2>

                
                

                <p>It turns out that things aren't as simple as they seemed in my last post. A couple of people have pointed out to me that Python can indeed do monkey patching - so what's the difference between this and Ruby? Am I just making a fuss over nothing? First of all, to some proper definitions.</p>
<h1>What Even Is Monkey Patching?</h1>
<p>It's also known as guerilla (/gorilla) patching, hot-fixing, and more recently, 'duck-punching'.</p>
<blockquote>
<p><strong>Geoffrey</strong>: Now, you went to PyCon a couple months ago. And it’s well-known that in the Python world, they frown on monkey-patching. Do you think they would think more positively of duck-punching?</p>
<p><strong>Adam</strong>: No, I think they will continue to look down on us, no matter how awesome and hilarious we become.</p>
<p><strong>Voice In Background</strong>: Isn’t that the truth.</p>
<p><strong>Geoffrey</strong>: I also have Patrick Ewing. Is this a good idea, and will it catch on?</p>
<p><strong>Patrick Ewing</strong>: Well, I was just totally sold by Adam, the idea being that if it walks like a duck and talks like a duck, it’s a duck, right? So if this duck is not giving you the noise that you want, you’ve got to just punch that duck until it returns what you expect.</p>
<p><a href="https://web.archive.org/web/20120114085702/http://podcast.rubyonrails.org/programs/1/episodes/railsconf-2007">Transcript from Geoffrey Grosenbach podcast</a> at RailsConf2007</p>
</blockquote>
<p>Monkey patching can mean some subtly different things:</p>
<ul>
<li>Changing a class's methods at runtime</li>
<li>Changing a class's methods at runtime <em>and making all the instances of that class change after the fact</em></li>
</ul>
<p>As pointed out in <a href="http://stackoverflow.com/questions/192649/can-you-monkey-patch-methods-on-core-types-in-python">this thread on StackOverFlow</a> by Dan Lenski, both variants are indeed possible with Python. Here's an example:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="n">Widget:</span>
    <span class="n">def</span> <span class="n">__init__</span>(<span class="k">self</span>):
       <span class="nb">pass</span>
    <span class="n">def</span> <span class="n">who_am_i</span>(<span class="k">self</span>):
       <span class="nb">print</span>(<span class="s">&quot;I&#39;m a widget&quot;</span>)

&gt;&gt;&gt; <span class="n">my_widget</span> = <span class="n">Widget</span>()
&gt;&gt;&gt; <span class="n">my_widget</span>
<span class="s">&lt;Widget object at 0x7f6b5aa52e80&gt;</span>
&gt;&gt;&gt; <span class="n">my_widget</span>.<span class="n">who_am_i</span>()
<span class="n">I&#39;m</span> <span class="n">a</span> <span class="n">widget</span>
&gt;&gt;&gt; <span class="n">def</span> <span class="n">teapot</span>(<span class="k">self</span>):
...     <span class="nb">print</span>(<span class="s">&quot;I&#39;m a little teapot&quot;</span>)
...
&gt;&gt;&gt; <span class="n">Widget</span>.<span class="n">who_am_i</span> = <span class="n">teapot</span>
&gt;&gt;&gt; <span class="n">my_widget</span>.<span class="n">who_am_i</span>()
<span class="n">I&#39;m</span> <span class="n">a</span> <span class="n">little</span> <span class="n">teapot</span>
&gt;&gt;&gt; <span class="n">new_widget</span> = <span class="n">Widget</span>()
&gt;&gt;&gt; <span class="n">new_widget</span>.<span class="n">who_am_i</span>()
<span class="n">I&#39;m</span> <span class="n">a</span> <span class="n">little</span> <span class="n">teapot</span>
</pre></div>


<p>And Python doesn't warn you either! So perhaps I was unfairly harsh to Ruby? Not quite.</p>
<h1>One <em>Important</em> Difference</h1>
<p><em>Unlike</em> with Ruby, we can't monkeypatch the basic built-in classes, such as <code>int</code>, <code>float</code> or <code>str</code>. This is because they are defined in C extension modules which are immutable. These modules are shared between multiple interpreters and made immutable for efficiency (and safety)'s sake. So when you try to change the behaviour of the built-ins, you can't -</p>
<div class="highlight"><pre><span></span>def own_up(self, a_string):
    return a_string.length()*&quot;!&quot;

&gt;&gt;&gt;my_string = &quot;Hello, World!&quot;
&gt;&gt;&gt; my_string.upper()
&#39;HELLO, WORLD!&#39;
&gt;&gt;&gt; str.upper = own_up
Traceback (most recent call last):
  File &quot;&lt;input&gt;&quot;, line 1, in &lt;module&gt;
TypeError: can&#39;t set attributes of built-in/extension type &#39;str&#39;
</pre></div>


<p>To do something which approximates the effects of monkeypatching a built-in we have to subclass, like so - this example lets us write a custom instance of the str.upper() method by inheriting from str.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="n">CustomString</span>(<span class="n">str</span>):
    <span class="n">def</span> <span class="n">upper</span>(<span class="k">self</span>):
        <span class="n">desired_value</span> = <span class="s">&quot;!&quot;</span> * <span class="n">len</span>(<span class="k">self</span>)
        <span class="k">return</span> <span class="n">CustomString</span>(<span class="n">desired_value</span>)

&gt;&gt;&gt; <span class="n">custom</span> = <span class="n">CustomString</span>(<span class="s">&quot;hello world&quot;</span>)
&gt;&gt;&gt; <span class="n">custom</span>
<span class="s">&#39;hello world&#39;</span>
&gt;&gt;&gt; <span class="n">custom</span>.<span class="n">upper</span>()
<span class="s">&#39;!!!!!!!!!!!&#39;</span>
</pre></div>


<p>Ta-da! I still maintain that this is saner behaviour than Ruby.</p>
<p>(Sidenote - Remember, for str and any class based on it, Python strings are immutable - when we call methods on a string, we just get a new return value that we have to assign to some other string object to store.)</p>
<h1>If Python and Ruby do it in similar ways, is Monkey Patching even All That Bad, then?</h1>
<p>Yes! I still maintain that monkey patching is dangerous and shouldn't be used often. I think it says something positive about Python that it's not something you need to know intimately in order to program competently in the language, and indeed most Python programmers I know feel a bit iffy about it. It's a little off-putting (to say the least) to realise how much of a way of life it is for Ruby programmers.</p>
<p>But don't just take my word for it - have a read of this <a href="http://www.virtuouscode.com/2008/02/23/why-monkeypatching-is-destroying-ruby/">insightful blog post</a> by Avdi Grimm, an experienced Rubyist worried about the impact of thoughtless 'hip' monkey patching - a choice quote:</p>
<blockquote>
<p>Where I work, we are already seeing subtle, difficult-to-debug problems crop up as the result of monkey patching in plugins.  Patches interact in unpredictable, combinatoric ways.  And by their nature, bugs caused by monkey patches  are more difficult to track down than those introduced by more traditional classes and methods.  As just one example: on one project, it was a known caveat that we could not rely on class inheritable attributes as provided by ActiveSupport.  No one knew why.</p>
</blockquote>
<p>A fun (scary) read.</p>
<h1>Temporary Monkey Patching in Python for testing</h1>
<p>As I was looking around at this stuff, I discovered there are a couple of libraries, <a href="https://docs.python.org/3/library/unittest.mock.html#patch"><code>unittest.mock.patch</code></a> and <a href="http://docs.pytest.org/en/latest/monkeypatch.html"><code>pytest monkeypatch</code></a> designed to allow <em>temporary</em> monkeypatching for testing - when the function or statement using it exits, the patch disappears. I can see how useful it would be to set up mocks in this controlled way, rather than having to worry about it affecting all of your tests. It was deemed so handy that <code>mock</code> is now part of the standard library in Python3. Time to investigate further!</p>
                <div class="clear"></div>

                <div class="info">
                    <a href="../monkey-patching.html">posted at 00:00</a>
                    &nbsp;&middot;
                    &nbsp;<a href="../tag/ruby.html" class="tags">Ruby</a>
                    &nbsp;<a href="../tag/python.html" class="tags selected">Python</a>
                </div>
		<a href="../monkey-patching.html#disqus_thread">Click to read and post comments</a>
            </article>            <h4 class="date">Jan 23, 2017</h4>

            <article class="post">
                <h2 class="title">
                    <a href="../stop-writing-classes.html" rel="bookmark" title="Permanent Link to &quot;Stop Writing (Unecessary) Classes&quot;">Stop Writing (Unecessary) Classes</a>
                </h2>

                
                

                <p>I listened to a great talk recently called <a href="https://www.youtube.com/embed/o9pEzgHorH0?feature=player_embedded&amp;iv_load_policy=3&amp;autoplay=1&amp;rel=0&amp;start=20">Stop Using Classes</a> by Peter Diedrich. The talk goes through some of the unhelpful ways classes can be used in Python and makes good points about readability and simplicity. Here's my mindmap of the talk.
<img alt="My mindmap of the talk" src="../images/stop_using_classes.jpg"> </p>
<h2>Game of Life</h2>
<p>Diedrich uses as an example a neat implementation of Conway's <a href="https://en.wikipedia.org/wiki/Conway's_Game_of_Life">Game of Life</a> which is beautifully straightforward and avoids the tempting trap of making a class for a Cell, a class for a Board, etc. His example is so small I've copied and annotated it here (renamed a few of the variables for extra clarity):</p>
<div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; Example Game of Life from &#39;Stop Writing Classes&#39; talk by Jack Diedrich. &quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">itertools</span>


<span class="k">def</span> <span class="nf">neighbours</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">point</span>
    <span class="k">yield</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">yield</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span>
    <span class="k">yield</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">yield</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">yield</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">yield</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">yield</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span>
    <span class="k">yield</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="mi">1</span>


<span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="n">board</span><span class="p">):</span>
    <span class="n">new_state</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># initialises a set with a blank list inside</span>
    <span class="n">friends</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="n">neighbours</span><span class="p">,</span> <span class="n">board</span><span class="p">)))</span>
    <span class="n">cells_we_care_about</span> <span class="o">=</span> <span class="n">board</span> <span class="o">|</span> <span class="n">friends</span>

    <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">cells_we_care_about</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">cell</span> <span class="ow">in</span> <span class="n">board</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">neighbours</span><span class="p">(</span><span class="n">point</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">board</span><span class="p">):</span>
            <span class="n">new_state</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_state</span>


<span class="n">glider</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)])</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">glider</span> <span class="o">=</span> <span class="n">advance</span><span class="p">(</span><span class="n">glider</span><span class="p">)</span>

<span class="k">print</span> <span class="n">glider</span>
</pre></div>


<p>What <code>friends</code> does requires some unpacking. First of all, <code>*map(neighbours, board)</code> takes the iterable returned from <code>map(neighbours, board)</code> and returns it. The <code>*</code> is a useful way to split up the returned single thing from <code>map</code> into each piece and feed them separately to the <code>chain()</code> function as arguments. Here's an example of <code>*</code> in action:</p>
<div class="highlight"><pre><span></span>def hallo(arg1, arg2):
     print(arg1)
     print(arg2)
     print(&quot;Hallo!!&quot;)

&gt;&gt;&gt; printme = (&quot;Yes&quot;, &quot;Indeed&quot;)
&gt;&gt;&gt; hallo(printme)
Traceback (most recent call last):
  File &quot;/usr/lib/python3.5/code.py&quot;, line 91, in runcode
    exec(code, self.locals)
  File &quot;&lt;input&gt;&quot;, line 1, in &lt;module&gt;
TypeError: hallo() missing 1 required positional argument: &#39;arg2&#39;
&gt;&gt;&gt; hallo(*printme)
Yes
Indeed
Hallo!!
</pre></div>


<p>This <code>map()</code> iterable is the function <code>neighbours()</code> applied to every point in <code>board</code>. So <code>map(neighbours, board)</code> returns sets of all the live cells' neighbours. This is used as an argument to the <code>chain()</code> function. What <code>chain()</code> does is glues groups of iterable things together into a <code>chain</code> object. For example:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">itertools</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">love</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="s2">&quot;123&quot;</span><span class="p">,</span> <span class="s2">&quot;DEF&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">love</span>
<span class="o">&lt;</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x7fe58ada5810</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">love</span><span class="p">:</span>
<span class="o">...</span>     <span class="k">print</span> <span class="n">item</span>
<span class="o">...</span>     
<span class="mi">1</span>
<span class="mi">2</span>
<span class="mi">3</span>
<span class="n">D</span>
<span class="n">E</span>
<span class="n">F</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">sling_it_into_a_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">love</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">sling_it_into_a_set</span>
<span class="nb">set</span><span class="p">([</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>


<p>So it bungs all the sets of neighbours into one single set. Because of how Python sets work, this gets rid of any duplicate points - eg points which neighbour a couple of living cells should still only be mentioned once.</p>
<p><code>|</code> is just Python's binary OR operator - so <code>cells_we_care_about</code> is a set which contains all points that are in the list of live cells OR the list of their neighbours</p>
<p><code>count</code> counts neighbours for each living and dead cell. Diedrich then applies the rules for Conway's Game of Life in one line: 
<em> A dead cell that has 3 live neighbours becomes alive
</em> A live cell that has 2 live neighbours remains alive
* Every other cell dies.</p>
<h2>Sets are awesome</h2>
<p>One of the reasons his implementation is so tidy and has so few lines is his great use of <code>set()</code>, one of the built-in Python types. Sets are particularly great for this problem because they contain only unique elements - if you try to add multiples of the same element to a set you only end up with one in there. This means any duplicate points are eliminated without having to think about it. </p>
<p>For more examples of how to get good use out of Python's built-ins I recommend <a href="https://www.youtube.com/watch?v=lyDLAutA88s">Built in Super Heroes</a> by the excellent Dave Beazley. </p>
                <div class="clear"></div>

                <div class="info">
                    <a href="../stop-writing-classes.html">posted at 00:00</a>
                    &nbsp;&middot;&nbsp;<a href="../category/python.html" rel="tag">python</a>
                    &nbsp;&middot;
                    &nbsp;<a href="../tag/python.html" class="tags">python</a>
                    &nbsp;<a href="../tag/classes.html" class="tags">classes</a>
                    &nbsp;<a href="../tag/talks.html" class="tags">talks</a>
                </div>
		<a href="../stop-writing-classes.html#disqus_thread">Click to read and post comments</a>
            </article>

            <div class="clear"></div>
            <footer>
                <p>
                <a href="https://github.com/jody-frankowski/blue-penguin">Blue Penguin</a> Theme
                &middot;
                Proudly Powered by <a href="http://getpelican.com">Pelican</a>
            </footer>
        </div>
        <div class="clear"></div>
    </div>
</body>
</html>